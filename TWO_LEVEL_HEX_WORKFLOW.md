# Two-Level Hierarchical Hex System Workflow

## Overview

Your app has a **two-level hierarchical hex system** that's already fully implemented:

1. **Level 1: Planetary Hexes** (continental scale, 500-1000km per hex)
2. **Level 2: Regional Hexes** (simulation scale, 10-50km per hex, with rivers & Unciv features)

This document explains the current implementation and how the integration plan enhances it.

---

## ğŸ—ºï¸ LEVEL 1: Planetary/Continental View

### Current Implementation âœ…

**Location:** `Planet.worldMap` (2D grid of HexTile or PlanetaryHexTile)

**Display:** `PlanetViewer` component â†’ `HexMapCanvas` section

**Features:**
- Shows entire planet as hex grid
- Terrain colors (grass = green, desert = yellow, ocean = blue, etc.)
- Continent detection and grouping
- Click hex â†’ Shows details panel
- Can see climate properties (elevation, temperature, dryness)

**What You See:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Planet: Earth                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚  ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ¦ğŸŸ¦ğŸŸ¦             â”‚ â”‚
â”‚ â”‚  ğŸŸ¦ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ«ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ¦ğŸŸ¦             â”‚ â”‚
â”‚ â”‚  ğŸŸ¦ğŸŸ©ğŸŸ©â›°ï¸ğŸŸ«ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ¦ğŸŸ¦              â”‚ â”‚
â”‚ â”‚  ğŸŸ¦ğŸŸ¦ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ¦ğŸŸ¦ğŸŸ¦             â”‚ â”‚
â”‚ â”‚  ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦             â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                          â”‚
â”‚ [Selected Hex (5, 3)]                    â”‚
â”‚ Terrain: Grassland                       â”‚
â”‚ Elevation: 3/10                          â”‚
â”‚ Temperature: 65Â°                         â”‚
â”‚ Continent: Pangaea (ID: 1)               â”‚
â”‚                                          â”‚
â”‚ [Expand to Regional Map] â† NEW BUTTON   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Entity Structure

**PlanetaryHexTile**
```typescript
{
  id: "planetary-hex-5-3",
  x: 5, y: 3,
  terrainType: TerrainType.Grass,
  elevation: 3,
  temperature: 65,
  dryness: 35,
  continentId: 1,

  // Link to Level 2
  hasRegionalMap: false, // Initially false
  regionalMapId: undefined // Set when expanded
}
```

---

## ğŸ” LEVEL 2: Regional/Simulation View

### Current Implementation âœ…

**Generated by:** `RegionalMapCreator.create(planetaryHex, planetType, seed)`

**Display:** `RegionalMapViewer` component

**Features:**
- 50x50 detailed hex grid (2,500 hexes)
- **Different planet types produce different maps:**
  - Earth-like â†’ Varied terrain (grass, plains, desert, tundra, mountains)
  - Desert â†’ Mostly desert, some plains/oasis
  - Ice â†’ Snow, tundra, frozen oceans
  - Jungle â†’ Dense tropical grass with jungle features
  - Volcanic â†’ Mountains, hills, lava, ash plains
  - Water â†’ Mostly ocean with small islands
  - Barren â†’ Desert + snow, no vegetation
- **Rivers generated automatically** (RiverGenerator)
- **Resources placed automatically** (ResourcePlacer)
  - Strategic: Iron, Horses, Coal, Oil, Aluminum, Uranium
  - Luxury: Gold, Silver, Gems, Spices, Silk, Furs, etc.
  - Bonus: Wheat, Cattle, Deer, Fish, etc.
- **Features:** Forest, Jungle, Marsh, Ice, Oasis
- **Unciv-style graphics** (already supported)
- **Inherits parent hex climate:**
  - 60% from planetary hex (respects planet type)
  - 40% local variation (adds detail)

**What You See:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Regional Map: Grassland Region (5, 3)            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚   50x50 Detailed Hex Map                     â”‚ â”‚
â”‚ â”‚   [Terrain tiles with rivers shown]          â”‚ â”‚
â”‚ â”‚                                               â”‚ â”‚
â”‚ â”‚   ğŸŒ¾ ğŸŒ¾ ğŸ”ï¸ ğŸŒ² ğŸŒ² ğŸ’ ğŸŒ¾ ğŸŒŠ ğŸŒŠ              â”‚ â”‚
â”‚ â”‚   ğŸŒ¾ â†—ï¸ ğŸŒ² ğŸŒ² â›°ï¸ ğŸŒ² ğŸŒ¾ ğŸŒŠ ğŸŒŠ              â”‚ â”‚
â”‚ â”‚   ğŸŒ¾ â†—ï¸ â†—ï¸ ğŸŒ² ğŸŒ² ğŸŒ¾ ğŸŒ¾ ğŸŒŠ ğŸŒŠ              â”‚ â”‚
â”‚ â”‚   ğŸœï¸ ğŸœï¸ â†—ï¸ ğŸŒ¾ ğŸŒ¾ ğŸŒ¾ âš”ï¸ ğŸŒŠ ğŸŒŠ             â”‚ â”‚
â”‚ â”‚   ğŸœï¸ â†—ï¸ â†—ï¸ ğŸŒ¾ ğŸ›ï¸ ğŸŒ¾ ğŸŒ¾ ğŸŒŠ ğŸŒŠ             â”‚ â”‚
â”‚ â”‚          â†‘ River flows down                  â”‚ â”‚
â”‚ â”‚          â†‘ City (simulation ready)           â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                  â”‚
â”‚ [Zoom Out to Planet] â† Back to Level 1          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Entity Structure

**RegionalMap**
```typescript
{
  id: "regional-map-5-3",
  parentPlanetaryHexId: "planetary-hex-5-3", // Links back to Level 1
  parentPlanetId: "planet-earth",
  width: 50,
  height: 50,

  // All regional hexes
  hexTileIds: [
    "regional-hex-0-0",
    "regional-hex-0-1",
    // ... 2,500 hex IDs
  ],

  // Simulation entities (populated when simulation runs)
  nationIds: [],
  cityIds: [],
  unitIds: [],
  historicalEventIds: [],
  battleIds: []
}
```

**RegionalHexTile** (one of 2,500)
```typescript
{
  id: "regional-hex-25-25",
  x: 25, y: 25,
  terrainType: TerrainType.Grass,
  elevation: 2,

  // Rivers (generated)
  hasRiver: true,
  riverSides: [0, 3], // River on edges 0 and 3

  // Features (generated)
  feature: "Forest",

  // Resources (generated)
  strategicResource: StrategicResource.Iron,
  luxuryResource: LuxuryResource.None,
  bonusResource: "Deer",

  // Improvements (built during simulation)
  improvement: Improvement.None, // Will be Mine, Farm, etc.
  hasRoad: false,
  hasRailroad: false,

  // Ownership (assigned during simulation)
  ownerNationId: undefined, // Set when nation claims
  ownerCityId: undefined, // Set when city expands

  // Military (during simulation)
  hasCity: false,
  cityId: undefined,
  hasUnit: false,
  unitIds: [],

  // Yields (calculated automatically)
  yields: {
    food: 2, // Grass = 2, Forest = -1, Iron Mine = 0
    production: 1, // Forest = +1, Iron Mine = +2
    gold: 1, // River bonus
    science: 0,
    culture: 0
  },

  // Combat
  defensiveBonus: 25, // Forest bonus
  movementCost: 2, // Forest penalty

  parentRegionalMapId: "regional-map-5-3",
  parentPlanetaryHexId: "planetary-hex-5-3"
}
```

---

## ğŸ”„ WORKFLOW: Level 1 â†’ Level 2

### User Journey

```
1. User starts at Planet
   â†“
2. Sees planetary hex grid (Level 1)
   â†“
3. Clicks a hex
   â†“
4. Details panel appears:
   - Terrain: Grassland
   - Elevation: 3/10
   - Temperature: 65Â°
   - Continent: Pangaea
   - [Expand to Regional Map] button â† CLICK THIS
   â†“
5. RegionalMapCreator runs:
   - Generates 50x50 detailed hex grid
   - Respects planet type (earth-like, desert, ice, etc.)
   - Generates rivers using RiverGenerator
   - Places resources using ResourcePlacer
   - Calculates yields for each hex
   - Creates RegionalMap entity
   - Creates 2,500 RegionalHexTile entities
   - Links: planetaryHex.regionalMapId = regionalMap.id
   - Saves all entities to entityStore
   â†“
6. Opens RegionalMapViewer (Level 2)
   - Shows 50x50 detailed map
   - Rivers visible (blue lines on hex edges)
   - Resources shown (icons on hexes)
   - Features shown (forests, etc.)
   - Can now run simulation on this map
```

### Code Flow

**PlanetViewer.svelte** (add this in Phase 4.1)
```svelte
<script lang="ts">
  let selectedHex: PlanetaryHexTile | null = $state(null);

  function handleHexClick(hex: PlanetaryHexTile) {
    selectedHex = hex;
  }

  async function expandToRegionalMap(hex: PlanetaryHexTile) {
    // Check if already expanded
    if (hex.hasRegionalMap && hex.regionalMapId) {
      openRegionalMap(hex.regionalMapId);
      return;
    }

    // Generate new regional map
    const regionalMap = RegionalMapCreator.create(
      hex,
      planet.type, // 'earth-like', 'desert', 'ice', etc.
      Date.now() // seed
    );

    // Link planetary hex to regional map
    hex.hasRegionalMap = true;
    hex.regionalMapId = regionalMap.id;

    // Save regional map entity
    const regionalMapEntity: Entity = {
      id: regionalMap.id,
      type: EntityType.RegionalMap,
      name: `${planet.name} - Region (${hex.x}, ${hex.y})`,
      description: `Detailed regional map expanded from planetary hex`,
      tags: ['simulation', 'map', 'generated'],
      parentId: parentEntity.id, // Planet
      metadata: { createdAt: new Date(), updatedAt: new Date() },
      relationships: [
        { targetId: hex.id, type: 'reference', label: 'expands' }
      ],
      customFields: {
        generatedEntity: regionalMap,
        planetaryHexId: hex.id
      }
    };

    entityStore.createEntity(regionalMapEntity);

    // Save all 2,500 regional hex tiles as entities
    for (const hexId of regionalMap.hexTileIds) {
      const regionalHex = entityStore.getEntity(hexId) as RegionalHexTile;
      const hexEntity: Entity = {
        id: regionalHex.id,
        type: EntityType.RegionalHexTile,
        name: `Hex (${regionalHex.x}, ${regionalHex.y})`,
        description: `${TerrainType[regionalHex.terrainType]} tile`,
        tags: ['hex', 'terrain'],
        parentId: regionalMap.id,
        metadata: { createdAt: new Date(), updatedAt: new Date() },
        relationships: [],
        customFields: { generatedEntity: regionalHex }
      };
      entityStore.createEntity(hexEntity);
    }

    // Update planet entity
    dispatch('entityUpdated', { entity: parentEntity });

    // Open regional map viewer
    dispatch('openEntity', { entity: regionalMapEntity });
  }

  function openRegionalMap(regionalMapId: string) {
    const entity = entityStore.getEntity(regionalMapId);
    if (entity) {
      dispatch('openEntity', { entity });
    }
  }
</script>

<!-- In hex details panel -->
{#if selectedHex}
  <div class="hex-details">
    <h3>Planetary Hex ({selectedHex.x}, {selectedHex.y})</h3>
    <InfoGrid items={hexDetails} />

    {#if selectedHex.hasRegionalMap}
      <button onclick={() => openRegionalMap(selectedHex.regionalMapId)}>
        ğŸ—ºï¸ Open Regional Map
      </button>
    {:else}
      <button onclick={() => expandToRegionalMap(selectedHex)} class="primary">
        ğŸ” Expand to Regional Map
      </button>
      <p class="help-text">
        Generate a detailed 50Ã—50 hex map with rivers, resources, and Unciv features
      </p>
    {/if}
  </div>
{/if}
```

---

## ğŸ® WORKFLOW: Simulation on Level 2

Once in Level 2 (RegionalMapViewer), user can run simulation:

```
1. User is in RegionalMapViewer
   - Sees 50Ã—50 detailed map
   - Rivers, resources, terrain all visible
   â†“
2. Clicks "Initialize Simulation"
   - Creates 3-8 nations
   - Places starting settlers/cities
   - Assigns nation colors
   â†“
3. Clicks "Run 500 Years"
   - Simulation processes turns
   - Cities appear on map (Unciv city icons)
   - Nations expand (colored hex overlays show borders)
   - Units move (Unciv unit icons)
   - Rivers still visible (under all layers)
   - Resources still visible (with nation overlays)
   â†“
4. User can:
   - Click hex â†’ see details (terrain, owner, yields)
   - Click city â†’ open CityViewer
   - Click unit â†’ open UnitViewer
   - Scrub timeline â†’ see history
   - View event log â†’ see all events
   - Export â†’ generate RPG backstory
```

---

## ğŸ” VIEW MODES (Level 2 Only)

### Terrain View (Default)
- Shows Unciv terrain sprites
- Rivers visible
- Resources visible
- No nation overlays
- **Use case:** See natural geography

### Political View
- Unciv terrain sprites (dimmed 70%)
- Nation border overlays (30% opacity colored fills)
- Cities with nation flags
- Units hidden
- **Use case:** See territory control

### Nation View
- Unciv terrain sprites (dimmed 50%)
- Selected nation's territory highlighted (50% opacity)
- That nation's cities and units shown
- Other nations dimmed
- **Use case:** Focus on one nation's empire

---

## ğŸ“‚ ENTITY HIERARCHY

```
Planet Entity
  â””â”€ customFields.generatedEntity: Planet
       â””â”€ worldMap: WorldMap
            â””â”€ hexTiles: HexTile[][] (Level 1 - simple)

  â””â”€ continents[] (nested)
       â””â”€ Continent Entity (per continent)
            â””â”€ hexTiles: HexTile[] (references to worldMap hexes)

PlanetaryHexTile Entity (per Level 1 hex)
  â””â”€ terrainType, elevation, temperature, dryness
  â””â”€ continentId (which continent)
  â””â”€ regionalMapId? (link to Level 2)

RegionalMap Entity (per expanded planetary hex)
  â””â”€ parentPlanetaryHexId (link to Level 1)
  â””â”€ width: 50, height: 50
  â””â”€ hexTileIds[2500] (all Level 2 hexes)
  â””â”€ nationIds[], cityIds[], unitIds[] (simulation entities)

  â””â”€ RegionalHexTile Entity (2,500 per regional map)
       â””â”€ terrainType, elevation, feature
       â””â”€ hasRiver, riverSides[]
       â””â”€ strategicResource, luxuryResource, bonusResource
       â””â”€ improvement, hasRoad, hasRailroad
       â””â”€ ownerNationId, ownerCityId
       â””â”€ cityId?, unitIds[]
       â””â”€ yields, defensiveBonus, movementCost

  â””â”€ Nation Entity (per simulation nation)
       â””â”€ cityIds[], unitIds[], resources, techs, policies

  â””â”€ City Entity (per simulation city)
       â””â”€ hexTileId (which regional hex)
       â””â”€ population, buildings, production, yields

  â””â”€ Unit Entity (per simulation unit)
       â””â”€ hexTileId (which regional hex)
       â””â”€ unitType, combatStrength, health

  â””â”€ HistoricalEvent Entity (per event)
       â””â”€ year, participants, description

  â””â”€ Battle Entity (per battle)
       â””â”€ hexTileId, attackerIds, defenderIds, outcome
```

---

## âœ… WHAT'S ALREADY WORKING

1. âœ… Two-level hex system architecture
2. âœ… RegionalMapCreator generates Level 2 from Level 1
3. âœ… Planet type affects regional map generation
4. âœ… River generation (RiverGenerator)
5. âœ… Resource placement (ResourcePlacer)
6. âœ… Feature generation (forests, jungles, marshes)
7. âœ… Yield calculation
8. âœ… RegionalMapViewer displays Level 2 maps
9. âœ… Unciv graphics support
10. âœ… RegionalHexTile has all simulation properties

---

## ğŸš§ WHAT THE PLAN ADDS

1. **UI to expand Level 1 â†’ Level 2** (Phase 4.1)
   - Add "Expand to Regional Map" button to PlanetViewer
   - Add "Zoom Out to Planet" button to RegionalMapViewer

2. **Simulation on Level 2** (Phases 1-6)
   - Initialize nations on regional map
   - Run simulation with time progression
   - Cities appear and grow on regional hexes
   - Units move and fight on regional hexes
   - Nations claim territory (regional hexes)
   - Rivers, resources, terrain remain visible throughout

3. **Multi-layer rendering** (Phase 2-3)
   - Layer 1: Unciv terrain sprites
   - Layer 2: Features (forests on terrain)
   - Layer 3: Resources (icons on hexes)
   - Layer 4: Improvements (farms, mines on hexes)
   - Layer 5: Nation borders (colored overlays)
   - Layer 6: Cities (Unciv city icons + labels)
   - Layer 7: Units (Unciv unit icons)
   - Layer 8: Rivers (visible in all layers)
   - Layer 9: Selection highlight

4. **Navigation between levels** (Phase 4)
   - Click planetary hex â†’ expand to regional
   - Click "back" in regional â†’ return to planetary
   - Continent boundaries visible in both views

5. **Entity integration** (Phase 1-2)
   - All simulation objects become permanent entities
   - Cities, nations, units saved in entityStore
   - Can open CityViewer, NationViewer, UnitViewer from map

---

## ğŸ¯ KEY INSIGHT

**The two-level system IS there and works!**

The plan just needs to:
1. Add the UI button to expand planetary hex â†’ regional map
2. Add simulation capability to run on the regional map
3. Show nation borders, cities, units on top of the existing terrain/rivers/resources

**All the hard work (terrain generation, rivers, resources) is done!** ğŸ‰

The simulation just needs to **use** the existing regional hexes (claim them, build on them, fight on them) while keeping all the geographic features visible.
